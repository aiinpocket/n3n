name: Build and Deploy Agents

on:
  push:
    branches: [ main, master ]
    paths:
      - 'agents/**'
      - '.github/workflows/build-agents.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'agents/**'
  workflow_dispatch:  # 允許手動觸發

env:
  AGENT_VERSION: '1.0.0'

jobs:
  build-macos:
    runs-on: macos-14  # Apple Silicon runner
    outputs:
      sha256: ${{ steps.info.outputs.sha256 }}
      size: ${{ steps.info.outputs.size }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '5.9'

      - name: Build macOS Agent (arm64)
        working-directory: agents/macos
        run: swift build -c release

      - name: Calculate hash and size
        id: info
        working-directory: agents/macos
        run: |
          SHA256=$(shasum -a 256 .build/release/n3n-agent | awk '{print $1}')
          SIZE=$(stat -f%z .build/release/n3n-agent)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: n3n-agent-macos-arm64
          path: agents/macos/.build/release/n3n-agent
          retention-days: 7

  build-windows:
    runs-on: windows-latest
    outputs:
      sha256: ${{ steps.info.outputs.sha256 }}
      size: ${{ steps.info.outputs.size }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        working-directory: agents/windows
        run: dotnet restore

      - name: Build Windows Agent (x64)
        working-directory: agents/windows
        run: |
          dotnet publish src/N3NAgent.CLI -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o ./publish

      - name: Calculate hash and size
        id: info
        working-directory: agents/windows
        shell: pwsh
        run: |
          $hash = (Get-FileHash ./publish/n3n-agent.exe -Algorithm SHA256).Hash.ToLower()
          $size = (Get-Item ./publish/n3n-agent.exe).Length
          echo "sha256=$hash" >> $env:GITHUB_OUTPUT
          echo "size=$size" >> $env:GITHUB_OUTPUT

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: n3n-agent-windows-x64
          path: agents/windows/publish/n3n-agent.exe
          retention-days: 7

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: n3n-agent-macos-arm64
          path: artifacts/macos

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: n3n-agent-windows-x64
          path: artifacts/windows

      - name: Prepare release files
        run: |
          # Rename artifacts for release
          mv artifacts/macos/n3n-agent artifacts/n3n-agent-macos-arm64
          mv artifacts/windows/n3n-agent.exe artifacts/n3n-agent-windows-x64.exe
          chmod +x artifacts/n3n-agent-macos-arm64

          # Create checksums file
          cd artifacts
          sha256sum n3n-agent-* > checksums.sha256

      - name: Generate release tag
        id: tag
        run: |
          RELEASE_TAG="agents-v${{ env.AGENT_VERSION }}-$(date +%Y%m%d%H%M%S)"
          echo "tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: N3N Agent ${{ env.AGENT_VERSION }} ($(date +%Y-%m-%d))
          body: |
            ## N3N Desktop Agent v${{ env.AGENT_VERSION }}

            ### Downloads

            | Platform | Architecture | File | SHA256 |
            |----------|--------------|------|--------|
            | macOS | arm64 (Apple Silicon) | `n3n-agent-macos-arm64` | `${{ needs.build-macos.outputs.sha256 }}` |
            | Windows | x64 | `n3n-agent-windows-x64.exe` | `${{ needs.build-windows.outputs.sha256 }}` |

            ### File Sizes
            - macOS arm64: ${{ needs.build-macos.outputs.size }} bytes
            - Windows x64: ${{ needs.build-windows.outputs.size }} bytes

            ### Installation

            #### macOS
            ```bash
            # Download and make executable
            chmod +x n3n-agent-macos-arm64
            ./n3n-agent-macos-arm64 --help
            ```

            #### Windows
            ```powershell
            # Run from command line
            .\n3n-agent-windows-x64.exe --help
            ```

            ### Requirements
            - macOS: 13.0 (Ventura) or later
            - Windows: Windows 10/11 x64
          files: |
            artifacts/n3n-agent-macos-arm64
            artifacts/n3n-agent-windows-x64.exe
            artifacts/checksums.sha256
          draft: false
          prerelease: false
