# N3N 平台架構需求規格書

> 版本: 2.0
> 日期: 2026-01-21
> 狀態: 需求確認階段

---

## 一、核心理念

### 1.1 平台定位

N3N 是一個**零侵入式的流程編排引擎**，核心特點：

1. **零規範約束** - 外部服務不需要遵循任何特定 API 規範即可接入
2. **自動發現** - 平台主動探測服務的 API 結構，而非要求服務主動註冊
3. **可視化映射** - 用戶在 UI 上自由配置節點間的數據映射關係
4. **多協議支援** - HTTP/HTTPS、gRPC、GraphQL、WebSocket、MQ 等
5. **熱插拔** - 服務上下線不影響平台運作，無需重啟

### 1.2 與現有設計的差異

| 項目 | 舊設計 (已實現) | 新需求 |
|------|----------------|--------|
| 服務接入 | 服務必須調用 API 主動註冊 | 平台自動發現，服務無感知 |
| API 規範 | 服務須遵循統一請求格式 | 任意 API 格式皆可 |
| 數據傳遞 | 固定的 input/output 結構 | 用戶自由映射任意欄位 |
| 協議支援 | 僅 HTTP + Redis Streams | HTTP/gRPC/GraphQL/MQ/WebSocket |
| 部署要求 | 服務需知道平台存在 | 服務完全獨立，不知道平台 |

---

## 二、系統架構

### 2.1 高階架構圖

```
┌─────────────────────────────────────────────────────────────────────┐
│                         N3N Platform                                 │
│                                                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐  │
│  │   Flow       │  │   Service    │  │     Schema Discovery     │  │
│  │   Designer   │  │   Catalog    │  │     Engine               │  │
│  │   (UI)       │  │              │  │  ┌─────────────────────┐ │  │
│  └──────┬───────┘  └──────┬───────┘  │  │ OpenAPI Parser      │ │  │
│         │                 │          │  │ gRPC Reflection     │ │  │
│         │                 │          │  │ GraphQL Introspect  │ │  │
│         ▼                 ▼          │  │ WSDL Parser         │ │  │
│  ┌─────────────────────────────────┐ │  └─────────────────────┘ │  │
│  │      Data Mapping Engine        │ └──────────────────────────┘  │
│  │  (欄位對應、轉換、表達式)         │                               │
│  └──────────────┬──────────────────┘                               │
│                 │                                                   │
│  ┌──────────────▼──────────────────────────────────────────────┐   │
│  │              Protocol Adapter Layer                          │   │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐    │   │
│  │  │  HTTP  │ │  gRPC  │ │GraphQL │ │  MQ    │ │  WS    │    │   │
│  │  │Adapter │ │Adapter │ │Adapter │ │Adapter │ │Adapter │    │   │
│  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘    │   │
│  └──────────────────────────┬───────────────────────────────────┘   │
└─────────────────────────────┼───────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│  Service A    │    │  Service B    │    │  Service C    │
│  (REST API)   │    │  (gRPC)       │    │  (GraphQL)    │
│               │    │               │    │               │
│  任意格式      │    │  任意格式      │    │  任意格式      │
│  無需改動      │    │  無需改動      │    │  無需改動      │
└───────────────┘    └───────────────┘    └───────────────┘
```

### 2.2 服務發現架構

```
┌─────────────────────────────────────────────────────────────────┐
│                    Service Discovery Layer                       │
│                                                                  │
│   輸入來源 (任選一種或多種)                                        │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  ① Kubernetes Service Discovery (自動)                   │   │
│   │  ② Consul / Eureka / Nacos (自動)                       │   │
│   │  ③ 手動輸入服務地址 (最小配置)                             │   │
│   │  ④ Docker Network Discovery                              │   │
│   └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │              Schema Auto-Discovery                       │   │
│   │                                                          │   │
│   │  服務地址 ──► 探測協議類型 ──► 獲取 Schema ──► 存入 Catalog │   │
│   │                                                          │   │
│   │  探測順序:                                                │   │
│   │  1. GET /openapi.json, /v3/api-docs, /swagger.json      │   │
│   │  2. gRPC Reflection API                                  │   │
│   │  3. GraphQL Introspection (__schema)                    │   │
│   │  4. 嘗試常見端點推斷結構                                   │   │
│   └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │              Unified Service Catalog                     │   │
│   │                                                          │   │
│   │  {                                                       │   │
│   │    "serviceId": "user-service",                         │   │
│   │    "endpoints": [                                        │   │
│   │      {                                                   │   │
│   │        "id": "getUser",                                 │   │
│   │        "protocol": "http",                              │   │
│   │        "method": "GET",                                 │   │
│   │        "path": "/api/users/{id}",                       │   │
│   │        "inputSchema": { ... },                          │   │
│   │        "outputSchema": { ... }                          │   │
│   │      }                                                   │   │
│   │    ]                                                     │   │
│   │  }                                                       │   │
│   └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三、核心功能需求

### 3.1 服務註冊 (最小配置)

用戶只需提供最基本的信息：

```yaml
# 最小配置 - 只需要這些
services:
  - name: "用戶服務"
    address: "http://user-service:8080"
    # 以下全部自動探測
    # protocol: auto-detect
    # schema: auto-discover
    # endpoints: auto-discover
```

或者透過 UI：
1. 輸入服務名稱
2. 輸入服務地址 (如 `http://192.168.1.100:8080`)
3. 點擊「探測」
4. 平台自動發現所有 API 端點和參數結構

### 3.2 Schema 自動發現

| 協議 | 發現方式 |
|------|----------|
| REST/HTTP | OpenAPI 3.x, Swagger 2.x, 或探測常見端點 |
| gRPC | gRPC Server Reflection Protocol |
| GraphQL | Introspection Query (`__schema`) |
| SOAP | WSDL 解析 |
| 無文檔服務 | 手動定義或 AI 輔助推斷 |

### 3.3 可視化數據映射

這是**最關鍵的功能**。用戶在 UI 上：

```
┌─────────────────────────────────────────────────────────────────┐
│                     Data Mapping Editor                          │
│                                                                  │
│  Source: Node A (用戶服務 - getUser)    Target: Node B (郵件服務) │
│  ┌─────────────────────┐              ┌─────────────────────┐   │
│  │ Output Schema       │              │ Input Schema        │   │
│  │                     │              │                     │   │
│  │ ├─ data             │   ──────►   │ ├─ to (string)      │   │
│  │ │  ├─ id ───────────┼───┐         │ ├─ subject (string) │   │
│  │ │  ├─ name          │   │         │ ├─ body (string)    │   │
│  │ │  ├─ email ────────┼───┼────────►│ └─ metadata         │   │
│  │ │  └─ department    │   │         │    └─ userId ◄──────┤   │
│  │ └─ timestamp        │   └─────────┼───────────────────────   │
│  └─────────────────────┘              └─────────────────────┘   │
│                                                                  │
│  映射規則:                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ to        = {{ $A.data.email }}                         │    │
│  │ subject   = "通知: " + {{ $A.data.name }}               │    │
│  │ body      = {{ $A.data | toJson }}                      │    │
│  │ metadata.userId = {{ $A.data.id }}                      │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

**關鍵點**：
- 拖拽式欄位映射
- 支援表達式和轉換函數
- 即時預覽轉換結果
- 不限制來源和目標的數據格式

### 3.4 多協議執行引擎

```
┌────────────────────────────────────────────────────────────────┐
│                   Protocol Adapter Interface                    │
│                                                                 │
│  interface ProtocolAdapter {                                    │
│    // 檢測服務是否使用此協議                                      │
│    boolean canHandle(ServiceEndpoint endpoint);                 │
│                                                                 │
│    // 發現服務的 Schema                                         │
│    ServiceSchema discoverSchema(ServiceEndpoint endpoint);      │
│                                                                 │
│    // 執行調用                                                   │
│    Object invoke(                                               │
│      ServiceEndpoint endpoint,                                  │
│      String operation,                                          │
│      Map<String, Object> params                                 │
│    );                                                           │
│  }                                                              │
└────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────┐
│                     Supported Adapters                            │
│                                                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ HttpAdapter │  │ GrpcAdapter │  │GraphQLAdapter│              │
│  │             │  │             │  │             │              │
│  │ - REST      │  │ - Unary     │  │ - Query     │              │
│  │ - SOAP      │  │ - Streaming │  │ - Mutation  │              │
│  │ - WebHook   │  │ - Reflection│  │ - Subscript │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ MqAdapter   │  │ WsAdapter   │  │ Custom      │              │
│  │             │  │             │  │ Adapter     │              │
│  │ - Kafka     │  │ - WebSocket │  │             │              │
│  │ - RabbitMQ  │  │ - Socket.IO │  │ - 可擴展    │              │
│  │ - Redis Pub │  │             │  │             │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└──────────────────────────────────────────────────────────────────┘
```

---

## 四、執行流程

### 4.1 工作流執行

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│ Node A  │────►│ Mapper  │────►│ Node B  │────►│ Mapper  │──► ...
│         │     │  A→B    │     │         │     │  B→C    │
└─────────┘     └─────────┘     └─────────┘     └─────────┘
     │               │               │               │
     ▼               ▼               ▼               ▼
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│ 調用     │     │ 數據    │     │ 調用     │     │ 數據    │
│ Service │     │ 轉換    │     │ Service │     │ 轉換    │
│ A API   │     │         │     │ B API   │     │         │
└─────────┘     └─────────┘     └─────────┘     └─────────┘
```

### 4.2 數據流轉詳細流程

```
Step 1: Node A 執行完成
        Output: { "user": { "id": 123, "email": "test@example.com" } }

Step 2: Data Mapper 執行映射規則
        Rule: to = {{ $nodeA.user.email }}
        Rule: userId = {{ $nodeA.user.id }}

Step 3: 生成 Node B 的輸入
        Input: { "to": "test@example.com", "userId": 123 }

Step 4: Protocol Adapter 調用 Node B
        HTTP POST http://email-service/send
        Body: { "to": "test@example.com", "userId": 123 }

Step 5: Node B 返回結果，繼續流程...
```

---

## 五、非功能需求

### 5.1 熱插拔

- 新服務部署後，平台應在 < 30 秒內發現
- 服務下線後，正在執行的工作流應優雅降級
- 服務重新上線後，自動恢復
- **絕不需要重啟平台**

### 5.2 性能要求

- gRPC 調用延遲 < 5ms (排除網路)
- HTTP 調用延遲 < 10ms (排除網路)
- 數據映射處理 < 1ms (1KB 數據)
- 支援單節點 1000 TPS 吞吐量

### 5.3 可靠性

- 服務調用失敗自動重試 (可配置)
- 斷路器保護
- 執行狀態持久化，支援故障恢復

---

## 六、技術選型建議

### 6.1 服務發現

| 選項 | 優點 | 缺點 |
|------|------|------|
| **Kubernetes Native** | K8s 環境零配置 | 僅限 K8s |
| **Consul** | 功能全面、跨平台 | 需額外部署 |
| **Eureka** | Spring 生態整合好 | Netflix 已停止維護 |
| **Nacos** | 阿里開源、功能全 | 社群較小 |

**建議**: 支援多種，讓用戶選擇。優先 K8s Native + Consul。

### 6.2 Schema 發現

| 類型 | 技術方案 |
|------|----------|
| OpenAPI | Swagger Parser |
| gRPC | grpc-reflection, protobuf 動態解析 |
| GraphQL | graphql-java introspection |
| 無文檔 | AI 輔助推斷 (ChatGPT/Claude API) |

### 6.3 數據映射

| 選項 | 說明 |
|------|------|
| **JSONata** | JSON 查詢和轉換語言 |
| **JMESPath** | AWS 使用的 JSON 查詢語言 |
| **Apache Camel** | 企業級集成框架 |
| **自研 DSL** | 完全控制，但開發成本高 |

**建議**: JSONata + 自研表達式擴展

### 6.4 gRPC 支援

```xml
<dependency>
    <groupId>io.grpc</groupId>
    <artifactId>grpc-netty-shaded</artifactId>
</dependency>
<dependency>
    <groupId>io.grpc</groupId>
    <artifactId>grpc-protobuf</artifactId>
</dependency>
<dependency>
    <groupId>io.grpc</groupId>
    <artifactId>grpc-services</artifactId> <!-- For reflection -->
</dependency>
```

---

## 七、UI 設計要點

### 7.1 服務管理頁

```
┌────────────────────────────────────────────────────────────┐
│  服務管理                                    [+ 新增服務]   │
├────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────┐ │
│  │ 🟢 用戶服務                                          │ │
│  │    地址: http://user-service:8080                    │ │
│  │    協議: REST (OpenAPI 3.0)                         │ │
│  │    端點: 12 個    上次探測: 5 分鐘前                   │ │
│  │    [重新探測] [查看 API] [編輯]                       │ │
│  └──────────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────────┐ │
│  │ 🟢 訂單服務                                          │ │
│  │    地址: order-service:9090                          │ │
│  │    協議: gRPC                                        │ │
│  │    端點: 8 個     上次探測: 2 分鐘前                   │ │
│  │    [重新探測] [查看 API] [編輯]                       │ │
│  └──────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────┘
```

### 7.2 新增服務 (極簡)

```
┌────────────────────────────────────────────────────────────┐
│  新增服務                                                  │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  服務名稱: [___________________]                           │
│                                                            │
│  服務地址: [http://_______________:____]                   │
│                                                            │
│  [自動探測協議和 API]                                       │
│                                                            │
│  ─────────────────────────────────────────                 │
│  探測結果:                                                  │
│  ✓ 檢測到 REST API (OpenAPI 3.0)                          │
│  ✓ 發現 15 個端點                                          │
│  ✓ Schema 解析完成                                         │
│                                                            │
│                              [取消]  [確認新增]             │
└────────────────────────────────────────────────────────────┘
```

### 7.3 數據映射編輯器

這是最複雜的 UI，需要：
- 左側: 來源節點的輸出 Schema (樹狀結構)
- 右側: 目標節點的輸入 Schema (樹狀結構)
- 中間: 連線表示映射關係
- 下方: 表達式編輯器 (進階映射)
- 預覽: 即時顯示映射結果

---

## 八、實施路線圖

### Phase 1: 基礎架構重構
- [ ] 設計統一的 Service Catalog 模型
- [ ] 實現 Protocol Adapter 介面
- [ ] 實現 HTTP Adapter + OpenAPI 發現
- [ ] 實現基礎數據映射引擎

### Phase 2: 多協議支援
- [ ] 實現 gRPC Adapter + Reflection
- [ ] 實現 GraphQL Adapter + Introspection
- [ ] 實現 MQ Adapter (Kafka/RabbitMQ)

### Phase 3: 服務發現整合
- [ ] 整合 Kubernetes Service Discovery
- [ ] 整合 Consul
- [ ] 實現自動健康檢查和狀態同步

### Phase 4: UI 重構
- [ ] 服務管理頁面
- [ ] 可視化數據映射編輯器
- [ ] Schema 瀏覽器

### Phase 5: 進階功能
- [ ] AI 輔助 Schema 推斷 (無文檔服務)
- [ ] 映射規則智能建議
- [ ] 性能監控和調優

---

## 九、關鍵設計原則

1. **對外部服務零侵入** - 服務不需要知道平台的存在
2. **協議無關** - 通過 Adapter 抽象，支援任意協議
3. **Schema 驅動** - 所有操作基於自動發現的 Schema
4. **映射即代碼** - 數據映射規則可版本控制、可測試
5. **漸進式增強** - 從最小配置開始，按需添加細節

---

## 十、與現有代碼的關係

現有的 `NodeHandler` 體系可以保留，作為**內建節點**使用：
- Code Node (JavaScript)
- Condition Node
- Loop Node
- Wait Node
- 等等

新的架構主要處理**外部服務節點**，兩者共存：

```
┌─────────────────────────────────────────────────┐
│                  Node Types                      │
│                                                  │
│  ┌──────────────────┐  ┌──────────────────────┐ │
│  │  Built-in Nodes  │  │  External Service    │ │
│  │  (NodeHandler)   │  │  Nodes (Adapter)     │ │
│  │                  │  │                      │ │
│  │  - Code          │  │  - 用戶服務.getUser  │ │
│  │  - Condition     │  │  - 訂單服務.create   │ │
│  │  - Loop          │  │  - 郵件服務.send     │ │
│  │  - HTTP Request  │  │  - 任意外部 API      │ │
│  └──────────────────┘  └──────────────────────┘ │
└─────────────────────────────────────────────────┘
```

---

*此文檔記錄了對 N3N 平台的完整需求理解，待架構師評審後進入設計階段。*
