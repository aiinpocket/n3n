# ============================================================
# N3N Flow Platform - Application Configuration
# ============================================================
# 大部分設定都有合理的預設值，開箱即用。
# 只有在需要連接外部服務或自訂行為時才需要設定環境變數。
# ============================================================

# Application
spring.application.name=n3n
server.port=${SERVER_PORT:8080}
spring.main.allow-bean-definition-overriding=true

# ============================================================
# Database (PostgreSQL) - 內建預設值，可選覆蓋
# ============================================================
# 預設使用 localhost:5432/n3n，適合開發和單機部署
# 如需使用外部資料庫，設定以下環境變數：
#   DATABASE_URL, DATABASE_USERNAME, DATABASE_PASSWORD
spring.datasource.url=${DATABASE_URL:jdbc:postgresql://localhost:5432/n3n}
spring.datasource.username=${DATABASE_USERNAME:n3n}
spring.datasource.password=${DATABASE_PASSWORD:n3n}
spring.datasource.driver-class-name=org.postgresql.Driver
spring.datasource.hikari.maximum-pool-size=${DB_POOL_SIZE:10}
spring.datasource.hikari.minimum-idle=${DB_MIN_IDLE:2}

# JPA / Hibernate
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.open-in-view=false

# ============================================================
# Redis - 內建預設值，可選覆蓋
# ============================================================
# 預設使用 localhost:6379，適合開發和單機部署
# 如需使用外部 Redis，設定以下環境變數：
#   REDIS_HOST, REDIS_PORT, REDIS_PASSWORD
spring.data.redis.host=${REDIS_HOST:localhost}
spring.data.redis.port=${REDIS_PORT:6379}
spring.data.redis.password=${REDIS_PASSWORD:}
spring.data.redis.timeout=60000

# ============================================================
# JWT Authentication - 自動產生，無需設定
# ============================================================
# JWT Secret 在首次啟動時自動產生並持久化到資料庫
# 每個系統實例都有獨立的密鑰，無需手動設定
# 如需手動覆蓋（例如叢集部署共用密鑰），可設定：
#   JWT_SECRET=<base64 encoded 32-byte key>
jwt.access-token-expiration-ms=${JWT_ACCESS_EXPIRATION:900000}
jwt.refresh-token-expiration-ms=${JWT_REFRESH_EXPIRATION:604800000}

# ============================================================
# Security
# ============================================================
app.max-login-attempts=${MAX_LOGIN_ATTEMPTS:5}
app.lock-duration-minutes=${LOCK_DURATION_MINUTES:30}
app.allowed-origins=${ALLOWED_ORIGINS:http://localhost:3000,http://localhost:8080}

# ============================================================
# Mail (選填 - 需要郵件功能時設定)
# ============================================================
spring.mail.host=${MAIL_HOST:smtp.gmail.com}
spring.mail.port=${MAIL_PORT:587}
spring.mail.username=${MAIL_USERNAME:}
spring.mail.password=${MAIL_PASSWORD:}
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true

# ============================================================
# Logging
# ============================================================
logging.level.root=${LOG_LEVEL_ROOT:INFO}
logging.level.com.aiinpocket.n3n=${LOG_LEVEL_APP:INFO}
logging.level.org.springframework.security=${LOG_LEVEL_SECURITY:WARN}

# ============================================================
# Housekeeping - 執行歷史清理
# ============================================================
housekeeping.enabled=${HOUSEKEEPING_ENABLED:true}
housekeeping.retention-days=${HOUSEKEEPING_RETENTION_DAYS:30}
housekeeping.archive-to-history=${HOUSEKEEPING_ARCHIVE:false}
housekeeping.batch-size=${HOUSEKEEPING_BATCH_SIZE:1000}
housekeeping.cron=${HOUSEKEEPING_CRON:0 0 2 * * ?}

# ============================================================
# Actuator - K8s Health Checks
# ============================================================
management.endpoints.web.exposure.include=health,info,metrics,prometheus
management.endpoint.health.show-details=when_authorized
management.endpoint.health.probes.enabled=true
management.health.livenessState.enabled=true
management.health.readinessState.enabled=true

# ============================================================
# Flyway Migration
# ============================================================
spring.flyway.enabled=true
spring.flyway.baseline-on-migrate=true
spring.flyway.baseline-version=1
spring.flyway.locations=classpath:db/migration

# ============================================================
# Execution Settings
# ============================================================
execution.history.retention-days=${EXECUTION_RETENTION_DAYS:30}
execution.max-concurrent=${EXECUTION_MAX_CONCURRENT:100}
execution.timeout-ms=${EXECUTION_TIMEOUT_MS:300000}

# ============================================================
# AI Provider (選填)
# ============================================================
ai.default-timeout-ms=${AI_DEFAULT_TIMEOUT:120000}
ai.rate-limit.default-rpm=${AI_RATE_LIMIT_RPM:60}
ai.rate-limit.default-tpm=${AI_RATE_LIMIT_TPM:100000}
ai.rate-limit.burst-multiplier=${AI_RATE_LIMIT_BURST:1.5}
ai.security.prompt-max-length=${AI_PROMPT_MAX_LENGTH:4000}
ai.security.enable-injection-detection=${AI_INJECTION_DETECTION:true}

# ============================================================
# Flow Optimizer (選填 - 本地 AI)
# ============================================================
flow-optimizer.enabled=${FLOW_OPTIMIZER_ENABLED:false}
flow-optimizer.url=${FLOW_OPTIMIZER_URL:http://localhost:8081}
flow-optimizer.timeout-ms=${FLOW_OPTIMIZER_TIMEOUT:30000}
flow-optimizer.model=phi-3-mini
flow-optimizer.temperature=0.7
flow-optimizer.max-tokens=1024
