# ============================================================
# N3N Flow Platform - Application Configuration
# ============================================================
# 大部分設定都有合理的預設值，開箱即用。
# 只有在需要連接外部服務或自訂行為時才需要設定環境變數。
# ============================================================

# Application
spring.application.name=n3n
server.port=${SERVER_PORT:8080}
spring.main.allow-bean-definition-overriding=true

# ============================================================
# Database (PostgreSQL) - 內建預設值，可選覆蓋
# ============================================================
# 預設使用 localhost:5432/n3n，適合開發和單機部署
# 如需使用外部資料庫，設定以下環境變數：
#   DATABASE_URL, DATABASE_USERNAME, DATABASE_PASSWORD
spring.datasource.url=${DATABASE_URL:jdbc:postgresql://localhost:5432/n3n}
spring.datasource.username=${DATABASE_USERNAME:n3n}
spring.datasource.password=${DATABASE_PASSWORD:n3n}
spring.datasource.driver-class-name=org.postgresql.Driver
spring.datasource.hikari.maximum-pool-size=${DB_POOL_SIZE:10}
spring.datasource.hikari.minimum-idle=${DB_MIN_IDLE:2}

# JPA / Hibernate
spring.jpa.hibernate.ddl-auto=${DDL_AUTO:update}
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.open-in-view=false

# Pagination
spring.data.web.pageable.max-page-size=100

# ============================================================
# Redis - 內建預設值，可選覆蓋
# ============================================================
# 預設使用 localhost:6379，適合開發和單機部署
# 如需使用外部 Redis，設定以下環境變數：
#   REDIS_HOST, REDIS_PORT, REDIS_PASSWORD
spring.data.redis.host=${REDIS_HOST:localhost}
spring.data.redis.port=${REDIS_PORT:6379}
spring.data.redis.password=${REDIS_PASSWORD:}
spring.data.redis.timeout=${REDIS_TIMEOUT:3000}
spring.data.redis.lettuce.pool.max-active=${REDIS_POOL_MAX_ACTIVE:50}
spring.data.redis.lettuce.pool.max-idle=${REDIS_POOL_MAX_IDLE:20}
spring.data.redis.lettuce.pool.min-idle=${REDIS_POOL_MIN_IDLE:5}
spring.data.redis.lettuce.shutdown-timeout=200ms

# ============================================================
# JWT Authentication - 自動產生，無需設定
# ============================================================
# JWT Secret 在首次啟動時自動產生並持久化到資料庫
# 每個系統實例都有獨立的密鑰，無需手動設定
# 如需手動覆蓋（例如叢集部署共用密鑰），可設定：
#   JWT_SECRET=<base64 encoded 32-byte key>
jwt.access-token-expiration-ms=${JWT_ACCESS_EXPIRATION:900000}
jwt.refresh-token-expiration-ms=${JWT_REFRESH_EXPIRATION:604800000}

# ============================================================
# Security
# ============================================================
app.max-login-attempts=${MAX_LOGIN_ATTEMPTS:5}
app.lock-duration-minutes=${LOCK_DURATION_MINUTES:30}
app.allowed-origins=${ALLOWED_ORIGINS:http://localhost:3000,http://localhost:8080}

# ============================================================
# WebSocket Security
# ============================================================
# STOMP WebSocket (瀏覽器客戶端)
n3n.websocket.require-authentication=${WEBSOCKET_REQUIRE_AUTH:true}

# Gateway WebSocket (Agent 連線)
n3n.gateway.allowed-origins=${GATEWAY_ALLOWED_ORIGINS:${app.allowed-origins}}
n3n.gateway.require-authentication=${GATEWAY_REQUIRE_AUTH:true}

# ============================================================
# Mail (選填 - 需要郵件功能時設定)
# ============================================================
spring.mail.host=${MAIL_HOST:smtp.gmail.com}
spring.mail.port=${MAIL_PORT:587}
spring.mail.username=${MAIL_USERNAME:}
spring.mail.password=${MAIL_PASSWORD:}
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true

# ============================================================
# Logging
# ============================================================
logging.level.root=${LOG_LEVEL_ROOT:INFO}
logging.level.com.aiinpocket.n3n=${LOG_LEVEL_APP:INFO}
logging.level.org.springframework.security=${LOG_LEVEL_SECURITY:WARN}

# ============================================================
# Housekeeping - 執行歷史清理
# ============================================================
housekeeping.enabled=${HOUSEKEEPING_ENABLED:true}
housekeeping.retention-days=${HOUSEKEEPING_RETENTION_DAYS:30}
housekeeping.archive-to-history=${HOUSEKEEPING_ARCHIVE:false}
housekeeping.batch-size=${HOUSEKEEPING_BATCH_SIZE:1000}
housekeeping.cron=${HOUSEKEEPING_CRON:0 0 2 * * ?}

# ============================================================
# Actuator - K8s Health Checks
# ============================================================
management.endpoints.web.exposure.include=${ACTUATOR_ENDPOINTS:health,info}
management.endpoint.health.show-details=when_authorized
management.endpoint.health.probes.enabled=true
management.health.livenessState.enabled=true
management.health.readinessState.enabled=true
# Disable mail health check (optional service, should not affect overall health)
management.health.mail.enabled=false

# ============================================================
# Flyway Migration
# ============================================================
spring.flyway.enabled=true
spring.flyway.baseline-on-migrate=true
spring.flyway.baseline-version=1
spring.flyway.locations=classpath:db/migration

# ============================================================
# Execution Settings
# ============================================================
execution.history.retention-days=${EXECUTION_RETENTION_DAYS:30}
execution.max-concurrent=${EXECUTION_MAX_CONCURRENT:100}
execution.timeout-ms=${EXECUTION_TIMEOUT_MS:300000}

# ============================================================
# Container Orchestration
# ============================================================
# 容器編排類型: docker (預設), kubernetes, auto (自動偵測)
# docker - 使用 Docker CLI 管理 Plugin 容器
# kubernetes - 使用 K8s API 管理 Plugin Pod/Service
# auto - 啟動時自動偵測環境（檢查 KUBERNETES_SERVICE_HOST 或 docker.sock）
n3n.orchestrator.type=${ORCHESTRATOR_TYPE:docker}

# ============================================================
# Kubernetes Settings (僅在 orchestrator.type=kubernetes 或 auto 偵測到 K8s 時使用)
# ============================================================
n3n.k8s.namespace=${K8S_NAMESPACE:n3n}
n3n.k8s.plugin-namespace=${K8S_PLUGIN_NAMESPACE:n3n-plugins}
n3n.k8s.service-account=${K8S_SERVICE_ACCOUNT:n3n-plugin-manager}

# ============================================================
# Docker / Plugin Container Security
# ============================================================
n3n.docker.enabled=${DOCKER_ENABLED:true}
n3n.docker.host=${DOCKER_HOST:unix:///var/run/docker.sock}
n3n.docker.network=${DOCKER_NETWORK:n3n-network}

# 容器資源限制
n3n.plugin.cpu-limit=${PLUGIN_CPU_LIMIT:1.0}
n3n.plugin.memory-limit=${PLUGIN_MEMORY_LIMIT:512m}
n3n.plugin.memory-swap-limit=${PLUGIN_MEMORY_SWAP_LIMIT:1g}
n3n.plugin.pids-limit=${PLUGIN_PIDS_LIMIT:100}

# Docker Content Trust 映像簽章驗證
# 啟用後只會拉取已簽章的映像
n3n.docker.content-trust=${DOCKER_CONTENT_TRUST:false}

# 可信任的 Registry 白名單（逗號分隔）
# 只有來自這些 Registry 的映像才會被允許
n3n.docker.trusted-registries=${DOCKER_TRUSTED_REGISTRIES:ghcr.io/n3n,docker.io/n3n}

# ============================================================
# AI Provider (選填)
# ============================================================
ai.default-timeout-ms=${AI_DEFAULT_TIMEOUT:120000}
ai.rate-limit.default-rpm=${AI_RATE_LIMIT_RPM:60}
ai.rate-limit.default-tpm=${AI_RATE_LIMIT_TPM:100000}
ai.rate-limit.burst-multiplier=${AI_RATE_LIMIT_BURST:1.5}
ai.security.prompt-max-length=${AI_PROMPT_MAX_LENGTH:4000}
ai.security.enable-injection-detection=${AI_INJECTION_DETECTION:true}

# ============================================================
# Embedding Service (選填 - 向量嵌入)
# ============================================================
# 可選值: openai, ollama, simple
# - openai: 使用 OpenAI text-embedding-3-small (需要 API key)
# - ollama: 使用本地 Ollama 服務 (需要安裝 nomic-embed-text)
# - simple: 簡單的字元雜湊嵌入 (不建議用於生產)
n3n.embedding.provider=${EMBEDDING_PROVIDER:openai}
n3n.embedding.timeout-ms=${EMBEDDING_TIMEOUT:30000}

# OpenAI Embedding 設定
n3n.embedding.openai.api-key=${OPENAI_API_KEY:}
n3n.embedding.openai.model=${OPENAI_EMBEDDING_MODEL:text-embedding-3-small}
n3n.embedding.openai.base-url=${OPENAI_BASE_URL:https://api.openai.com}
n3n.embedding.openai.dimension=${OPENAI_EMBEDDING_DIMENSION:1536}

# Ollama Embedding 設定 (本地部署)
n3n.embedding.ollama.base-url=${OLLAMA_BASE_URL:http://localhost:11434}
n3n.embedding.ollama.model=${OLLAMA_EMBEDDING_MODEL:nomic-embed-text}

# ============================================================
# Memory Store (對話記憶持久化)
# ============================================================
# 可選值: postgres, redis, inmemory
# - postgres: 使用 PostgreSQL + pgvector (推薦用於生產)
# - redis: 使用 Redis (需要 Redis Stack 或 RedisSearch)
# - inmemory: 記憶體存儲 (僅適合開發測試)
n3n.memory.store=${MEMORY_STORE:postgres}

# ============================================================
# Flow Optimizer (選填 - 本地 AI)
# ============================================================
flow-optimizer.enabled=${FLOW_OPTIMIZER_ENABLED:true}
flow-optimizer.url=${FLOW_OPTIMIZER_URL:http://localhost:8081}
flow-optimizer.timeout-ms=${FLOW_OPTIMIZER_TIMEOUT:30000}
flow-optimizer.model=phi-3-mini
flow-optimizer.temperature=0.7
flow-optimizer.max-tokens=1024

# ============================================================
# OpenAPI / Swagger UI
# ============================================================
springdoc.swagger-ui.path=/swagger-ui.html
springdoc.swagger-ui.enabled=${SWAGGER_ENABLED:false}
springdoc.api-docs.path=/v3/api-docs
springdoc.api-docs.enabled=${SWAGGER_ENABLED:false}
springdoc.packages-to-scan=com.aiinpocket.n3n
springdoc.paths-to-exclude=/actuator/**

# ============================================================
# Request Size Limits
# ============================================================
server.max-http-request-header-size=8KB
server.tomcat.max-http-form-post-size=2MB
server.tomcat.max-swallow-size=2MB
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=10MB
